<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Facturación e Inventario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- <link rel="stylesheet" href="../static/css/styles.css"> -->
  <style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: rgb(137, 138, 196);
        color: #343a40;
    }
    
    h2, h4, h5 {
        font-weight: 600;
    }

    .card {
        border-radius: 10px;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
    }
    
    input.form-control, select.form-select {
        border-radius: 8px;
    }
    
    button.btn {
        border-radius: 8px;
    }

    #somic {
        text-align: center;
    }
    
    #tablaKardex th {
        background-color: #e9ecef;
        text-align: center;
    }
    
    #tablaKardex td {
        vertical-align: middle;
        text-align: center;
    }
    
    #totalCostos, #totalVenta {
        font-weight: bold;
        color: #198754;
    }
  
  </style>
</head>
<body class="bg-light p-4">

  <div class="container">
    <h2 class="mb-4">Factura e Inventario</h2>
    <h4 class="mb-4 card" id="somic">SOMIC SOLUCIONES S.A.S.</h4>

    <!-- NIT -->
    <div class="card mb-3">
      <div class="card-body">
        <h5>Datos del Cliente</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <input type="text" id="nitInput" class="form-control" placeholder="Ingrese NIT">
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary" onclick="buscarCliente()">Buscar</button>
          </div>
        </div>
        <div id="infoCliente" class="mt-3"></div>
      </div>
    </div>

    <!-- Factura proxima a vencer -->
    <div class="card mb-3">
      <div class="card-body">
        <h5>Factura Próxima a Vencer</h5>
        <div id="infoFactura"></div>
      </div>
    </div>

    <!-- Inventario -->
    <div class="card mb-3">
      <div class="card-body">
        <h5>Inventario</h5>
        <div class="row g-2 mb-2">
          <div class="col-md-4">
            <input type="text" id="codigoArticulo" class="form-control" placeholder="Código del artículo">
          </div>
          <div class="col-md-2">
            <button class="btn btn-success" onclick="buscarArticulo()">Buscar artículo</button>
          </div>
        </div>
        <div id="infoArticulo"></div>

        <!-- Movimiento -->
        <form id="formMovimiento" onsubmit="guardarMovimiento(event)">
          <div class="row g-2">
            <div class="col-md-2">
              <select id="naturaleza" class="form-select" onchange="toggleCampos()">
                <option value="entrada">Entrada</option>
                <option value="salida">Salida</option>
              </select>
            </div>
            <div class="col-md-2">
              <input type="number" class="form-control" id="unidades" placeholder="Unidades">
            </div>
            <div class="col-md-2">
              <input type="number" class="form-control" id="costos" placeholder="Costo unitario">
            </div>
            <div class="col-md-2">
              <input type="number" class="form-control" id="precioVenta" placeholder="Precio venta">
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Kardex -->
    <div class="card">
      <div class="card-body">
        <h5>Kardex</h5>
        <table class="table table-bordered" id="tablaKardex">
          <thead>
            <tr>
              <th>Artículo</th>
              <th>Entrada</th>
              <th>Salida</th>
              <th>Saldo</th>
              <th>Costo</th>
              <th>Precio Venta</th>
              <th>Total Costos</th>
              <th>Total Venta</th>
              <th>Fecha Vencimiento</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="d-flex justify-content-between">
          <div>Total Costos: <span id="totalCostos">0</span></div>
          <div>Total Venta: <span id="totalVenta">0</span></div>
        </div>
      </div>
    </div>

  </div>

  <script>
    function buscarCliente() {
        const nit = document.getElementById('nitInput').value;
        axios.get(`/api/facturas/info/${nit}`)
            .then(res => {
                const data = res.data;
                const cliente = data.nit;
                const factura = data.facturaProxima;
    
                document.getElementById('infoCliente').innerHTML = `
                    <p><strong>Nombre:</strong> ${cliente.nitNom}</p>
                    <p><strong>Cupo:</strong> $${cliente.nitCup}</p>
                    <p><strong>Plazo:</strong> ${cliente.nitPla} días</p>
                    <p><strong>Cartera:</strong> $${cliente.nitCar}</p>
                    <p><strong>Disponible:</strong> $${cliente.nitDis}</p>
                `;
    
                if (factura) {
                    const fechaCreacion = new Date(factura.facFecha).toLocaleDateString('es-ES');
                    const fechaVencimiento = new Date(factura.facFVen).toLocaleDateString('es-ES');
                    document.getElementById('infoFactura').innerHTML = `
                        <p><strong>Número:</strong> ${factura.facNum}</p>
                        <p><strong>Fecha de creación:</strong> ${fechaCreacion}</p>
                        <p><strong>Fecha de vencimiento:</strong> ${fechaVencimiento}</p>
                    `;
    
                    console.log("Factura recibida:", factura); 
                } else {
                    document.getElementById('infoFactura').innerHTML = `<p>No hay factura próxima registrada.</p>`;
                }
            })
            .catch(() => {
                alert('Cliente no encontrado');
            });
    }
    
    function buscarArticulo() {
        const cod = document.getElementById('codigoArticulo').value;
        axios.get(`/api/articulos/${cod}`)
            .then(res => {
                const art = res.data;
                document.getElementById('infoArticulo').innerHTML = `
                    <p><strong>Nombre:</strong> ${art.artNom}</p>
                    <p><strong>Laboratorio:</strong> ${art.artLab}</p>
                    <p><strong>Saldo:</strong> ${art.artSal}</p>
                `;
            })
            .catch(() => {
                alert('Artículo no encontrado');
            });
    }
    
    function toggleCampos() {
        const naturaleza = document.getElementById('naturaleza').value;
        const costos = document.getElementById('costos');
        const precioVenta = document.getElementById('precioVenta');
    
        if (naturaleza === 'entrada') {
            costos.removeAttribute('disabled');
            precioVenta.setAttribute('disabled', 'true');
        } else {
            costos.setAttribute('disabled', 'true');
            precioVenta.removeAttribute('disabled');
        }
    }
    
    function guardarMovimiento(e) {
      e.preventDefault();

      const nit = document.getElementById('nitInput').value;
      const codArt = document.getElementById('codigoArticulo').value;
      const naturaleza = document.getElementById('naturaleza').value;
      const unidades = parseInt(document.getElementById('unidades').value);
      const costos = parseFloat(document.getElementById('costos').value);
      const precioVenta = parseFloat(document.getElementById('precioVenta').value);

      if (!nit || !codArt || !unidades || (naturaleza === 'entrada' && isNaN(costos)) || (naturaleza === 'salida' && isNaN(precioVenta))) {
          alert('Completa todos los campos requeridos');
          return;
      }

      if (naturaleza === 'salida' && precioVenta <= costos) {
          alert('El precio de venta debe ser mayor al costo unitario.');
          return;
      }

      const payload = {
          nitDoc: nit,
          artCod: codArt,
          naturaleza: naturaleza,
          karCantEnt: naturaleza === 'entrada' ? unidades : 0,
          karCantSal: naturaleza === 'salida' ? unidades : 0,
          karCosUnit: naturaleza === 'entrada' ? costos : 0,
          karPreVen: naturaleza === 'salida' ? precioVenta : 0
      };

      const endpoint = naturaleza === 'entrada' ? '/api/kardex/entrada' : '/api/kardex/salida';

      axios.post(endpoint, payload)
          .then(() => {
              alert('Movimiento registrado con éxito');
              cargarKardex();
          })
          .catch(() => {
              alert('Error al guardar el movimiento');
          });
    }

    
    function cargarKardex() {
        const codArt = document.getElementById('codigoArticulo').value;
        axios.get(`/api/kardex/${codArt}`)
            .then(res => {
                const tbody = document.querySelector('#tablaKardex tbody');
                tbody.innerHTML = '';
                let totalCostos = 0;
                let totalVenta = 0;
    
                res.data.forEach(entry => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${entry.artNom}</td>
                            <td>${entry.karCantEnt}</td>
                            <td>${entry.karCantSal}</td>
                            <td>${entry.karSaldo}</td>
                            <td>${entry.karCosUnit}</td>
                            <td>${entry.karPreVen}</td>
                            <td>${entry.karTotCos}</td>
                            <td>${entry.karTotVen}</td>
                            <td>${entry.karFecVencProd ? new Date(entry.karFecVencProd).toLocaleDateString() : '-'}</td>
                        </tr>
                    `;
                    totalCostos += entry.karTotCos;
                    totalVenta += entry.karTotVen;
                });
    
                document.getElementById('totalCostos').textContent = totalCostos.toFixed(2);
                document.getElementById('totalVenta').textContent = totalVenta.toFixed(2);
            })
            .catch(error => {
                console.error('Error al cargar kardex:', error);
                alert('Error al cargar el kardex');
            });
    }
    </script>
    

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- <script src="../static/js/app.js"></script> -->
</body>
</html>
